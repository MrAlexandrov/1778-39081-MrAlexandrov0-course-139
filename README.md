# Данные и индексы

## Описание

В одной фруктовой компании стали случаться сбои и часто происходило падение сервиса. При разборе инцидентов выяснилось, что в какой-то момент СУБД загружается на 100% и увеличивается время ответа. 

Проблема оказалась в долгом выполнение запросов поиска пользователей.

Помогите настроить индексы в базе данных так, чтобы эти запросы выполнялись быстрее.

## Запуск проекта

Чтобы разобраться в том как работает сервис первым делом необходимо его локально запустить.

Для этого понадобятся:

- [Docker](https://docs.docker.com/manuals/) для запуска контейнеров
  - Если вы не знаете что это такое, то стоит прочитать короткий [ликбез](https://sam-ngu.medium.com/docker-tutorial-getting-started-80775e93d4d)
  - Описания уже готовых контейнеров лежат в файле `docker-compose.yml`
- [Make](https://www.gnu.org/software/make/manual/make.html)
  - Если вы не знаете что это такое, то стоит прочитать короткий [ликбез](https://swarnakar-ani24.medium.com/a-noobs-guide-to-using-make-and-writing-makefile-f718135d816b)
  - Описания уже готовых команд находятся в файле `Makefile`

Проект состоит из трех контейнеров:

- store - база данных
- service - сервис поиска данных

Чтобы запустить проект выполните шаги:

1. Соберите образ сервиса командой `make build`

2. Запустите контейнеры командой `make up`
   - После запуска будет выполнен health-check, если он не проходит то нужно разобраться в чем проблема (по [логам](#просмотр-логов)) и устранить её
  
3. Проверьте что все три контейнер запущены и работают командой `make status`

### Выполнение запросов

Чтобы проэмулировать реальное взаимодействия пользователя с сервисом можно выполнить какие-нибудь запросы:

- Поиск пользователей: `curl "localhost:8000/v1/users/?search=Nəzirova"`

- Поиск пользователей по расширенному набору полей и сортировкой: `curl "localhost:8000/v2/users/?search=874"`

Вы можете найти тексты выполняющихся запросов и время их выполнения в [логах](#просмотр-логов).

### Просмотр логов

Если вы используете Docker Desktop, то прямо в нём можно удобно смотреть логи и выполнять команды внутри контейнеров.

Также это можно сделать командой `make logs`.

## Подключение к базе

Дополнительно можно подключиться к базе, чтобы смотреть таблицы, их схемы и выполнять запросы.

Например, это можно сделать при помощи плагина [PostgreSQL](https://marketplace.visualstudio.com/items?itemName=ckolkman.vscode-postgres) к vscode.

Данные для подключения:
    - host: `127.0.0.1`
    - port: `5432`
    - user: `user`
    - password: `random`

Альтернативный вариант - консольная утилита `psql`.  Для входа в интерактивный режим выполните команду `make psql`. Подробнее о работе с `psql` - [документация](https://www.postgresql.org/docs/current/app-psql.htm).

## Оптимизация запросов

Контейнер service пишет в [логи](#просмотр-логов), какие SQL запросы выполняет - именно эти запросы нужно соптимизировать, добавив индексы. Для анализа этих запросов, [подключитесь к базе](#подключение-к-базе) любым способ и используйте SQL команду [EXPLAIN ANALYZE](https://www.postgresql.org/docs/current/sql-explain.html). Эта команда показывает сколько времени на какие операции тратит база в процессе выполнения запроса.

## Как сдать домашку 

Нужно описать недостающие индексы:

- tasks/task_v1.sql - для оптимизации запросов `/v1/users/?search=...`;
- tasks/task_v2.sql - для оптимизации запросов  `/v2/users/?search=...`;
- tasks/task_v3_orders.sql - для оптимизации запросов  `/pending_orders`;

Индексы нужно исправлять в контейнере store и дублировать в файле `tasks/task_v[1|2|*].sql`. Нужно убедиться, что при применении индексы не падают.

## Автотесты

Для запуска автотестов нужно обновиться из базового репозитория и сделать коммит.

Методика проверки:

1. Будут применены SQL скрипты в файлах `tasks/task_v1.sql`, `tasks/task_v2.sql`, `tasks/task_v3_orders.sql` и сделаны замеры производительности

**TODO:** для запуска использовать `make test` ?
